<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投稿一覧 - Simpdon クライアント</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
    <div class="container">
        <h1>投稿一覧</h1>
        <div id="posts" class="posts"></div>
        <div class="actions">
            <a href="post.html" class="button">新しい投稿</a>
            <a href="login.html" class="logout-link">ログアウト</a>
        </div>
    </div>
    <script>
        function getCookie(name) {
            var nameEq = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i].trim();
                if (c.indexOf(nameEq) === 0) return c.substring(nameEq.length, c.length);
            }
            return null;
        }

        var instanceUrl = getCookie('instanceUrl');
        var accessToken = getCookie('accessToken');

        if (!instanceUrl || !accessToken) {
            window.location.href = 'login.html';
        }

        function fetchPosts() {
            var apiUrl = instanceUrl + "/api/v1/timelines/public";

            fetch(apiUrl, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTPエラー: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                displayPosts(data);
            })
            .catch(error => {
                console.error(error);
                document.getElementById('posts').innerHTML = '<p>投稿の読み込みに失敗しました。</p>';
            });
        }

        function displayPosts(posts) {
            var postsContainer = document.getElementById('posts');
            postsContainer.innerHTML = '';

            posts.forEach(post => {
                var postElement = document.createElement('div');
                postElement.classList.add('post');

                var username = post.account.acct;
                var content = post.content;
                var images = post.media_attachments.map(attachment => `<img src="${attachment.url}" alt="画像" class="post-image" />`).join('');

                postElement.innerHTML = `<h2>@${username}</h2><p>${content}</p>${images}`;
                postsContainer.appendChild(postElement);
            });
        }

        window.onload = fetchPosts;
    </script>
</body>
</html>
