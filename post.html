<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新しい投稿 - Simpdon クライアント</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
    <div class="container">
        <h1>新しい投稿</h1>
        <div class="post-form">
            <textarea id="new-post" placeholder="ここにトゥートを入力..." rows="4"></textarea>
            <input type="file" id="image-upload" accept="image/*" />
            <button id="submit-post" class="button">トゥートする</button>
        </div>
        <a href="timeline.html" class="link">投稿一覧に戻る</a>
        <a href="login.html" class="link">ログアウト</a>
    </div>

    <script>
        // ログイン確認
        const instanceUrl = localStorage.getItem('instanceUrl');
        const accessToken = localStorage.getItem('accessToken');
        if (!instanceUrl || !accessToken) {
            window.location.href = 'login.html'; // ログインしていなければログインページに遷移
        }

        // 投稿ボタンのクリックイベント
        document.getElementById('submit-post').addEventListener('click', function () {
            const content = document.getElementById('new-post').value.trim();
            const imageFile = document.getElementById('image-upload').files[0]; // アップロードされた画像ファイル

            if (content || imageFile) {
                let mediaId = null;

                // 画像が選択されている場合、アップロードしてメディアIDを取得
                if (imageFile) {
                    const formData = new FormData();
                    formData.append('file', imageFile);

                    const mediaRequest = new XMLHttpRequest();
                    mediaRequest.open('POST', instanceUrl + '/api/v1/media', true);
                    mediaRequest.setRequestHeader('Authorization', 'Bearer ' + accessToken);
                    
                    // 画像アップロードの成功時の処理
                    mediaRequest.onload = function () {
                        if (mediaRequest.status === 200) {
                            const mediaData = JSON.parse(mediaRequest.responseText);
                            mediaId = mediaData.id;

                            // 投稿処理を実行
                            sendPost(content, mediaId);
                        } else {
                            alert('画像のアップロードに失敗しました');
                        }
                    };

                    // 画像アップロードのエラー処理
                    mediaRequest.onerror = function () {
                        alert('画像のアップロードに失敗しました');
                    };

                    mediaRequest.send(formData);
                } else {
                    // 画像がない場合、そのまま投稿処理
                    sendPost(content, mediaId);
                }
            } else {
                alert('投稿内容を入力してください');
            }
        });

        // 投稿を送信する関数
        function sendPost(content, mediaId) {
            const postData = {
                status: content,
                media_ids: mediaId ? [mediaId] : [] // メディアIDがあれば、投稿に添付
            };

            const postRequest = new XMLHttpRequest();
            postRequest.open('POST', instanceUrl + '/api/v1/statuses', true);
            postRequest.setRequestHeader('Authorization', 'Bearer ' + accessToken);
            postRequest.setRequestHeader('Content-Type', 'application/json');

            // 投稿成功時
            postRequest.onload = function () {
                if (postRequest.status === 200) {
                    alert('投稿が成功しました');
                    window.location.href = 'timeline.html'; // 投稿成功後に投稿一覧に遷移
                } else {
                    const errorData = JSON.parse(postRequest.responseText);
                    alert('投稿に失敗しました: ' + errorData.error);
                }
            };

            // 投稿エラー処理
            postRequest.onerror = function () {
                alert('投稿に失敗しました');
            };

            postRequest.send(JSON.stringify(postData));
        }
    </script>
</body>
</html>
