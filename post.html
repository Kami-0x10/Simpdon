<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新しい投稿</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
    <div class="container">
        <h1>新しい投稿</h1>
        <form id="postForm">
            <label for="content">内容</label>
            <textarea id="content" name="content" required placeholder="投稿内容を入力してください..." rows="4"></textarea>
            <button type="submit" class="button">投稿する</button>
        </form>
        <div id="errorMessage" style="color: red; display: none;">投稿に失敗しました。もう一度試してください。</div>
        <div id="successMessage" style="color: green; display: none;">投稿が成功しました！</div>
        <div class="actions">
            <a href="timeline.html" class="button">タイムラインに戻る</a>
        </div>
    </div>

    <script>
        // Cookieから値を取得する関数
        function getCookie(name) {
            const nameEq = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i].trim();
                if (c.indexOf(nameEq) === 0) return c.substring(nameEq.length, c.length);
            }
            return "";
        }

        // ログイン状態を確認
        const instanceUrl = getCookie('instanceUrl');
        const accessToken = getCookie('accessToken');
        if (!instanceUrl || !accessToken) {
            window.location.href = 'login.html'; // ログインしていなければログインページに遷移
        }

        // 投稿フォームの送信処理
        document.getElementById('postForm').addEventListener('submit', function(event) {
            event.preventDefault(); // デフォルトのフォーム送信を防ぐ

            const content = document.getElementById('content').value.trim();
            if (content === "") {
                alert("投稿内容を入力してください！");
                return;
            }

            // 投稿をサーバーに送信
            const xhr = new XMLHttpRequest();
            const API_URL = `${instanceUrl}/api/v1/statuses`; // 投稿APIのエンドポイント
            xhr.open("POST", API_URL, true);
            xhr.setRequestHeader("Authorization", `Bearer ${accessToken}`);
            xhr.setRequestHeader("Content-Type", "application/json");

            // 送信するデータ
            const data = JSON.stringify({
                status: content
            });

            xhr.onload = function() {
                if (xhr.status === 200) {
                    // 投稿成功時の処理
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('errorMessage').style.display = 'none';
                    document.getElementById('content').value = ''; // フォームをクリア
                } else {
                    // 投稿失敗時の処理
                    document.getElementById('errorMessage').style.display = 'block';
                    document.getElementById('successMessage').style.display = 'none';
                    console.error('Error posting content:', xhr.status, xhr.responseText);
                }
            };

            xhr.onerror = function() {
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
                console.error('Error posting content');
            };

            xhr.send(data);
        });
    </script>
</body>
</html>
